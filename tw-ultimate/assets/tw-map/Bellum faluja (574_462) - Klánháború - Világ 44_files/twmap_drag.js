TWMap.initMap=function(){$("#map_blend").hide(),this.mapHandler.scrollBound=this.scrollBound;var e=new FreeMap(document.getElementById("minimap"),[5,5],50,this.minimapHandler,0);if(e.createMover(1),this.minimap=e,this.minimapWidth=$("#minimap").width(),this.minimapHeight=$("#minimap").height(),this.minimapHandler.scrollBound=this.getMinimapScrollBound(),TWMap.minimap_only)return void this.scaleMinimap();var a=new FreeMap(document.getElementById("map"),this.tileSize,this.mapSubSectorSize,this.mapHandler,26500);!$.browser.msie,a.createMover(this.mobile?1:2),this.map=a,this.legend=new MapLegend($("#map_legend")),this.legend.updateVisibility(),this.scaleMinimap(),this.minimapHandler.scrollBound=this.getMinimapScrollBound(),this.map_el_coordx=document.getElementById("map_coord_x"),this.map_el_coordy=document.getElementById("map_coord_y"),this._coord_el_y=[],this._coord_el_y_active=[],this._coord_el_x=[],this._coord_el_x_active=[];var i;for(i=0;i<1e3;i++){var t;t=document.createElement("div"),t.style.height=this.map.scale[1]+"px",t.style.lineHeight=this.map.scale[1]+"px",t.style.verticalAlign="middle",t.style.position="absolute",t.style.top=i*this.map.scale[1]-this.map.bias+"px",t.style.left="0px",t.innerHTML=i,this._coord_el_y.push(t),this._coord_el_y_active.push(!1),t=document.createElement("div"),t.style.width=this.map.scale[0]+"px",t.style.textAlign="center",t.style.position="absolute",t.style.left=i*this.map.scale[0]-this.map.bias+"px",t.style.top="0px",t.innerHTML=i,this._coord_el_x.push(t),this._coord_el_x_active.push(!1)}this.popup.init(),"undefined"!=typeof Warplanner&&Warplanner.init(),mobile||CommandPopup.hookCommandSent(function(e){TWMap.premium&&"attack"===e.type&&(TWMap.updateCommandIcon(e.target_village,"attack",!0),TWMap.popup.invalidateVillage(e.target_village.id)),TWMap.premium&&"support"===e.type&&(TWMap.updateCommandIcon(e.target_village,"incoming_support",!0),TWMap.popup.invalidateVillage(e.target_village.id))}),$(document).keydown(TWMap.onKeyDown),$(document).keyup(TWMap.onKeyUp)},TWMap.focus=function(e,a){var e=~~Math.max(e,this.scrollBound.x_min+this.size[0]/2),a=~~Math.max(a,this.scrollBound.y_min+this.size[1]/2);e=Math.min(e,this.scrollBound.x_max+1-this.size[0]/2),a=Math.min(a,this.scrollBound.y_max+1-this.size[1]/2),TWMap.map&&TWMap.map.centerPos(e,a,!0),TWMap.minimap_only&&TWMap.minimap.centerPos(e,a,!0),TWMap.pos=[e,a],TWMap.home.updateDisplay()},TWMap.mapHandler.spawnSector=function(e,a){if(!TWMap.minimap_only){var i=a.x-e.x,t=i+TWMap.mapSubSectorSize,p=a.y-e.y,s=p+TWMap.mapSubSectorSize;(TWMap.church.displayed||TWMap.politicalMap.displayed||TWMap.warMode||TribalWars._settings.map_show_watchtower)&&MapCanvas.createCanvas(a,e),a.dom_fragment=document.createDocumentFragment();var o=this._createBorder(a.x%100==0);if(o.style.width="1px",o.style.height=TWMap.mapSubSectorSize*TWMap.tileSize[1]+"px",a.appendElement(o,0,0),o=this._createBorder(a.y%100==0),o.style.height="1px",o.style.width=TWMap.mapSubSectorSize*TWMap.tileSize[0]+"px",a.appendElement(o,0,0),TWMap.ghost){var n=TWMap.ghost.x,l=TWMap.ghost.y;if(n>=a.x&&n<a.x+TWMap.mapSubSectorSize&&l>=a.y&&l<a.y+TWMap.mapSubSectorSize){n-TWMap.ghost.x,l-TWMap.ghost.y;TWMap.villages[1e3*n+l]={owner:0,points:0,img:TWMap.ghost_village_tile,special:"ghost"}}}var r;for(r in e.tiles)if(e.tiles.hasOwnProperty(r)&&(r=parseInt(r),!(r<i||r>=t))){var m;for(m in e.tiles[r])if(e.tiles[r].hasOwnProperty(m)&&(m=parseInt(m),!(m<p||m>=s))){var d=document.createElement("img");d.style.position="absolute",d.style.zIndex="2";var M=TWMap.villages[1e3*(e.x+r)+e.y+m];if(M){var c=M.owner,h=M.owner>0&&TWMap.players[M.owner]?TWMap.players[M.owner].ally:0;if(0==M.owner){if(TWMap.villageColors[M.id]){var W=TWMap.villageColors[M.id],T=TWMap.createVillageDot(W);a.appendElement(T,r-i,m-p)}}else{var W=null;W=M.id==game_data.village.id?TWMap.colors.this:TWMap.getColorByPlayer(c,h,M.id),d.style.backgroundColor="rgb("+W[0]+","+W[1]+","+W[2]+")"}imgsrc=TWMap.images[M.img],d.id="map_village_"+M.id,d.setAttribute("src",TWMap.graphics+imgsrc),TribalWars._settings.map_casual_hide&&parseInt(M.owner)!==parseInt(game_data.player.id)&&$.inArray(M.owner,TWMap.non_attackable_players)!==-1&&(d.style.opacity=.4,d.style.filter="alpha(opacity=40)");var u,y=TWMap.createVillageIcons(M);for(u=0;u<y.length;u++)a.appendElement(y[u],r-i,m-p);$(d).mouseout(TWMap.popup.hide())}else d.setAttribute("src",TWMap.graphics+TWMap.images[e.tiles[r][m]]);a.appendElement(d,r-i,m-p)}}a._element_root.appendChild(a.dom_fragment),a.dom_fragment=void 0}},TWMap.scrolling=!1,TWMap.scrollBlock=function(e,a){if(!this.scrolling){this.scrolling=!0;var i=[TWMap.pos[0]+TWMap.size[0]*e,TWMap.pos[1]+TWMap.size[1]*a],t=setInterval(function(){if(e==-1&&TWMap.map.viewport[0]<=TWMap.scrollBound.x_min||a==-1&&TWMap.map.viewport[1]<=TWMap.scrollBound.y_min||1==e&&TWMap.map.viewport[2]>=TWMap.scrollBound.x_max||1==a&&TWMap.map.viewport[3]>=TWMap.scrollBound.y_max)return clearInterval(t),void(TWMap.scrolling=!1);if(e>0&&TWMap.pos[0]>=i[0]||e<0&&TWMap.pos[0]<=i[0]||a>0&&TWMap.pos[1]>=i[1]||a<0&&TWMap.pos[1]<=i[1])return clearInterval(t),void(TWMap.scrolling=!1);var p=[TWMap.pos[0],TWMap.pos[1]];TWMap.pos[0]!=i[0]&&(p[0]+=e),TWMap.pos[1]!=i[1]&&(p[1]+=a),TWMap.focus(p[0],p[1])},30)}},TWMap._resizeID=null,TWMap.resizeMinimap=function(e,a){var i=e*this.minimap.scale[0],t=e*this.minimap.scale[1];TWMap.minimap.resize(i,t,a||!1),setTimeout(function(){TWMap.notifyMapSize()},250)},TWMap.resize=function(e,a){0==e?(dstWidth=$(window).width(),dstHeight=Math.max(window.outerHeight,window.innerHeight),TWMap.fullscreen||(dstWidth-=100,dstHeight-=100),this.isAutoSize=!0):"number"==typeof e?(dstWidth=e*this.map.scale[0],dstHeight=e*this.map.scale[1],this.isAutoSize=!1):(dstWidth=e[0]*this.map.scale[0],dstHeight=e[1]*this.map.scale[1],this.isAutoSize=!1),$.browser.msie&&(a=!1),TWMap.map.resize(dstWidth,dstHeight,a?1:0),TWMap.home.updateDisplay()},TWMap.minimapHandler.onResize=function(e,a){TWMap.scaleMinimap()},TWMap.mapHandler.onResizeBegin=function(){TWMap.isAutoSize=!1,TWMap.isDragResizing=!0,TWMap.popup.unregister()},TWMap.mapHandler.onResizeEnd=function(){TWMap.notifyMapSize(!1),TWMap.isDragResizing=!1,TWMap.popup.register();var e=$("#map_coord_y_wrap");e.css("height",e.height()-17+"px")},TWMap.minimapHandler.onResizeEnd=function(){TWMap.notifyMapSize(!1),TWMap.positionMinimap()},TWMap.mapHandler.onResize=function(e,a){TWMap.scaleMinimap(),TWMap.size=TWMap.map.coordByPixel(e,a,!1),TWMap.isDragResizing||TWMap.notifyMapSize(TWMap.isAutoSize)},TWMap.mapHandler.getResizableElements=function(){return[[document.getElementById("map_coord_x_wrap")],[document.getElementById("map_coord_y_wrap")]]},TWMap.onKeyDown=function(e){var a=document.activeElement,i="INPUT"===a.tagName&&"text"===a.type;if(HotKeys.enabled&&!i){TWMap.keys[e.keyCode]=!0;var t=TWMap.map.pos,p=[0,0];TWMap.keys.hasOwnProperty(37)&&(p[0]-=15),TWMap.keys.hasOwnProperty(38)&&(p[1]-=15),TWMap.keys.hasOwnProperty(39)&&(p[0]+=15),TWMap.keys.hasOwnProperty(40)&&(p[1]+=15),0==p[0]&&0==p[1]||(e.preventDefault(),TWMap.map.setPosPixel(t[0]+p[0],t[1]+p[1]))}},TWMap.onKeyUp=function(e){HotKeys.enabled&&delete TWMap.keys[e.keyCode]};
